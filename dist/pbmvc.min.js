/*!
 * pbMvc JavaScript MVC v0.1.0
 * https://github.com/Saartje87/pbMvc
 *
 * Copyright 2012 Niek Saarberg
 * Licensed MIT
 *
 * Build date 2012-10-30 09:10
 */
(function(e,t,n){typeof module!="undefined"&&typeof module.exports=="object"?module.exports=n(t):typeof define=="function"&&typeof define.amd=="object"?define(function(){return n(t)}):this[e]=n(t)})("pbMvc",this,function(e,t){"use strict";function u(e){var t=[],n="^";return e.replace(r,function(e,r,i,s,o,u,a){n+="(",r?(t.push(o),s&&!u?n+=".*":(n+=u?u:"[a-z0-9_-]",n+=i?"+":"*")):(t.push(!1),n+=o),n+=")",r||(n+="+"),a&&(n+=a,n+=i?"+":"*")}),{regexp:n,properties:t}}var n=e.PB,r=/(:?)(\!?)(\*?)([a-z0-9_-]+)(\[.*?\])*([\/\.|]*)/ig,i=!!window.history.pushState,s,o={};return o.Request=PB.Class({prefix:"http_",cache:{},hash:null,base:"/",pushstate:!1,construct:function(e){PB.overwrite(this,e),this.history=new s(this),this._execute=this.execute.bind(this),this.pushstate&&i?PB(window).on("popstate",this._execute):"onhashchange"in window?PB(window).on("hashchange",this._execute):setInterval(this.hashCheck.bind(this),250),setTimeout(this._execute,1)},navigate:function(e,t){return e=e.replace(window.location.protocol+"//"+window.location.hostname,""),t&&t.silent?this.execute(e,t):(this.pushstate&&i?(window.history.pushState("","",e),this.execute(e)):window.location.hash="!"+e,this)},execute:function(e,t){PB.is("String",e)||(e=this.pushstate&&i?window.location.pathname:window.location.hash),e=e.replace(/^[#!\/\s]+/g,"").replace(/\/\/+/g,"/").replace(/^\/|\/$/g,""),t=PB.extend(this.matchRoute(e),t);if(!t){console.log("Request did not match any route");return}var n=this.prefix+t.action,r=t.controller,s,u;if(!o.Controller[r]){console.exception("`"+r+"` not found");return}u=o.Controller[r].prototype;if(!u[n]){console.exception("`"+n+"` not found in `"+s+"`");return}return s=this.cache[r],s||(s=this.cache[r]=new o.Controller[r]),PB.type(u.before)==="function"&&s.before(t),s[n](t),PB.type(u.after)==="function"&&s.after(t),this.history.push(e,t),this},matchRoute:function(e){var t;return PB.each(o.Route.all(),function(n,r){if(t=r.matches(e))return!0;t=null}),t},hashCheck:function(){window.location.hash!==this.hash&&(this.hash=window.location.hash,this.execute())}}),o.Route=PB.Class({construct:function(e,t,n){this._name=e,this._regex=t,this._extract=n,this._defaults=null},defaults:function(e){this._defaults=PB.overwrite({},e)},matches:function(e){var t=e.match(this._regex),n=PB.overwrite({},this._defaults||{});if(!t)return!1;t.shift();for(var r=0;r<t.length;r++)t[r]&&this._extract[r]&&(n[this._extract[r]]=t[r]);return n}}),PB.extend(o.Route,{routes:{},all:function(){return o.Route.routes},set:function(e,t){if(o.Route.routes[e]){console.exception("Already declared route::"+e);return}var n=u(t);return n.regexp=new RegExp(n.regexp,"i"),o.Route.routes[e]=new o.Route(e,n.regexp,n.properties)}}),o.Model=PB.Class(PB.Observer,{name:null,url:"/{name}/rest/{id}.json?recursive=1",data:null,previousData:null,_settingData:!1,construct:function(e){if(!this.name)return this.error("Model.name required");this.parent(),this.data={},this.previousData={},e!==t&&this.set("id",e).fetch()},set:function(e,t){var n=this.data[e];return n===t?this:(this._dataChanged=!0,this.data[e]=t,this._settingData||(this.emit("change",this),this.emit("change:"+e,this,e)),this)},setData:function(e){return this._settingData=!0,this._dataChanged=!1,PB.each(e,this.set,this),this._settingData=!1,this._dataChanged&&this.emit("change",this),this},get:function(e){var n=this.data[e];return n===t||n===null?null:n},getData:function(){return PB.overwrite({},this.data)},isset:function(e){return this.data[e]!==t},unset:function(e){return this.data[e]=void 0,this},isValid:function(){},error:function(e){return console.log("Silent fail :) -> ",e),this},getUrl:function(){return this.url.replace("{name}",this.name).replace("{id}",this.get("id")||"")},fetch:function(){return this.get("id")?((new PB.Request({url:this.getUrl(),async:!1})).on("end",function(e,t){switch(t){case 200:e.responseJSON||this.error("No valid JSON response"),this.setData(e.responseJSON);break;default:this.error("Error in fetching `Model "+this.name+"`")}},this).send(),this):this.error("Failed to fetch `"+this.name+"`, no id set!")},save:function(){(new PB.Request({url:this.getUrl(),method:this.get("id")?"PUT":"POST",data:{__data:JSON.stringify(this.data)}})).on("end",this.crudCallback,this).send()},remove:function(){if(!this.get("id"))return this.error("Already removed? No id");(new PB.Request({url:this.getUrl(),method:"DELETE"})).on("end",this.crudCallback,this).send()},crudCallback:function(e,t){switch(t){case 200:case 201:if(!e.responseJSON)return this.error("No valid JSON response");this.setData(e.responseJSON);break;case 401:return this.error("Unauthorized");case 405:return this.error("Method Not Allowed");default:return this.error("CRUD error: `"+t+"`")}}}),o.Collection=PB.Class(PB.Observer,{url:"/{model}/search.json",data:null,params:null,allowedParams:{"page-index":!0,"max-results":!0,order:!0,q:!0,"total-pages":!1,"total-results":!1},previousData:null,model:null,construct:function(e){this.data=[],this.params={},this.parent(),PB.overwrite(this,e);if(!this.model||!o.Model[this.model])return this.error("Model `"+this.model+"` not found")},error:function(e){return console.log("Silent fail :) -> ",e),this},getUrl:function(){return this.url.replace("{model}",this.model)},save:function(){},remove:function(){},add:function(e){return PB.type(e)==="object"&&this.data.push(e),this},clear:function(){return this.data.length=0,this},setData:function(e){e.forEach(this.add,this)},setParam:function(e,t){return e in this.allowedParams&&(this.params[e]=t),this},getParam:function(e){return this.params[e]||t},setParams:function(e){return PB.each(e,this.setParam,this),this},getParams:function(){return PB.overwrite({},this.params)},find:function(){},findAll:function(e){var t=PB.overwrite({},this.params);e&&(t.q=e),PB.each(t,function(e,n){this.allowedParams[e]||delete t[e]},this),(new PB.Request({url:this.getUrl(),data:t})).on("end",this.searchCallback,this).send()},searchCallback:function(e,t){switch(t){case 200:case 201:if(!e.responseJSON)return this.error("No valid JSON response");PB.each(e.responseJSON,function(e,t){e in this.allowedParams&&this.setParam(e,t)},this),this.setData(e.responseJSON.results),this.emit("load",this);break;case 401:return this.error("Unauthorized");case 405:return this.error("Method Not Allowed");default:return this.error("CRUD error: `"+t+"`")}}}),o.View=PB.Class({construct:function(e,n){this.filename=e||this.filename,this.expire=n===t?o.View.expire:n},setView:function(e){this.view=e},fetch:function(e){return this.view=PB.App.View.fetch(this.filename,this.expire),this},render:function(e){return this.view}}),PB.overwrite(o.View,{version:"VERSION",cache:{},expire:3600,collecting:!1,fetch:function(e,t){if(o.View.cache[e]&&Date.now()<o.View.cache[e].expire)return o.View.cache[e].text;var n=new PB.Request({url:e,async:!1,data:{ac:o.View.version}});return o.View.cache[e]={expire:Date.now()+t*1e3},n.on("end",function(t,n){switch(n){case 404:console.exception("View file `"+e+"` not found");break;case 200:o.View.cache[e].text=t.responseText;break;default:console.exception("Response didn`t return a valid code, returned "+n)}}).send(),o.View.collecting||(setInterval(o.View.collectGarbage,1e4),o.View.collecting=!0),o.View.cache[e].text},collectGarbage:function(){var e=Date.now();PB.each(o.View.cache,function(e,t){Date.now()>t.expire&&delete o.View.cache[e]})}}),o.Controller=PB.Class({}),s=PB.Class({limit:20,construct:function(){this.entries=[],this.length=0},push:function(e,t){this.length>=this.limit&&this.entries.shift(),this.entries.push({url:e,params:t}),this.length=this.entries.length},current:function(){return this.entries[this.length-1]},item:function(e){return e<=0?this.entries[e+this.length-1]:this.entries[e]}}),n.App=o});